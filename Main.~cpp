//---------------------------------------------------------------------------
#include <vcl.h>
#pragma hdrstop
//---------------------------------------------------------------------------
#include "Main.h"
#include "About.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TFormMain *FormMain;
//---------------------------------------------------------------------------
__fastcall TFormMain::TFormMain(TComponent* Owner)
    : TForm(Owner)
{
}
//---------------------------------------------------------------------------
static int FilesCount;
static int DirsCount;
static __int64 FilesSize;
static int         Err;
static AnsiString  DirName;
static AnsiString  BaseDirName;
static AnsiString  FileName;
static AnsiString  NewFileName;
static bool Continue;
//---------------------------------------------------------------------------
void SearchTree()
{
    TSearchRec  Sr;
    Err=FindFirst("*.*",faAnyFile,Sr) ;
    while(Continue &&(!Err))
    {
        Application->ProcessMessages();
        if(Sr.Name[1]!='.')
        {
            if(!(Sr.Attr & faDirectory))
            {
                FileName=ExpandFileName(Sr.Name);
                FormMain->StatusBar1->SimpleText=MinimizeName(FileName,FormMain->StatusBar1->Canvas,200);
                if(UpperCase(FileName).Pos("."+FormMain->EditSourceExt->Text.UpperCase())>0)
                {
                    FilesSize=FilesSize+Sr.Size;
                    FilesCount++;
                    NewFileName=ChangeFileExt(FileName,"."+FormMain->EditDestExt->Text);
					RenameFile(FileName,NewFileName);
                }
            }
        }

        // Begin Recursion
        if((Sr.Attr & faDirectory)&&(Sr.Name[1] != '.'))
        {
            DirName=ExpandFileName(Sr.Name);

            DirsCount++;
            SetCurrentDir(Sr.Name);
            SearchTree();
            SetCurrentDir("..") ;
        }
        // End Recursion
        Err=FindNext(Sr) ;
    }
}
//---------------------------------------------------------------------------
void __fastcall TFormMain::BitBtn1Click(TObject *Sender)
{
    StatusBar1->SimpleText="";
    BaseDirName=IncludeTrailingBackslash(DirectoryListBox1->Directory);
    DirName=BaseDirName;

    FilesCount=0;
    DirsCount=0;
    FilesSize=0;
    SetCurrentDir(DirName);
    Continue=true;
    SearchTree();
    StatusBar1->SimpleText="";
    MessageDlg("Success...",mtInformation,TMsgDlgButtons()<<mbOK,0);
}
//---------------------------------------------------------------------------
void __fastcall TFormMain::FormKeyDown(TObject *Sender, WORD &Key,
      TShiftState Shift)
{
    switch(Key)
    {
        case VK_ESCAPE:
        {
            Continue=false;
            break;
        }
    }
}
//---------------------------------------------------------------------------

void __fastcall TFormMain::FormCreate(TObject *Sender)
{
    AppPath=ExtractFilePath(Application->ExeName)+"\\";
}
//---------------------------------------------------------------------------

void __fastcall TFormMain::FormDestroy(TObject *Sender)
{
//
}
//---------------------------------------------------------------------------

void __fastcall TFormMain::BitBtn2Click(TObject *Sender)
{
    Continue=false;
    Application->Terminate();    
}
//---------------------------------------------------------------------------

void __fastcall TFormMain::SpeedButton1Click(TObject *Sender)
{
    FormAbout->ShowModal();    
}
//---------------------------------------------------------------------------

